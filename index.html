<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>断線利用レールループ生成ツール</title>
<style>
  body {
    font-family: sans-serif;
    background: #f5f5f5;
    color: #222;
    margin: 0;
    padding: 20px;
  }
  h1 { font-size: 20px; margin-bottom: 10px; }
  #HowtoUse { margin-top: 30px; font-size: 32px; }
  label { display:block; margin-top:10px; }
  input,select,button {
    margin-top:5px; padding:5px 8px; font-size:14px;
  }
  button {
    margin-right: 10px;
    cursor: pointer;
  }
  .button-group {
    margin-top: 10px;
  }
  #results { margin-top:15px; font-family: monospace; white-space:pre-wrap; font-size:15px;}
  
  .collapsible {
    background-color: #e7e7e7;
    color: #222;
    cursor: pointer;
    padding: 10px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 14px;
    margin-top: 10px;
    border-radius: 4px;
  }
  
  .collapsible:hover {
    background-color: #ddd;
  }
  
  .collapsible:after {
    content: '\002B';
    color: #222;
    font-weight: bold;
    float: right;
    margin-left: 5px;
  }
  
  .collapsible.active:after {
    content: "\2212";
  }
  
  .content {
    padding: 0 18px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
    background-color: #f9f9f9;
    border-radius: 0 0 4px 4px;
  }
  
  .content.show {
    max-height: 400px;
    padding: 18px;
  }
  
  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  
  .checkbox-item {
    display: flex;
    align-items: center;
  }
  
  .checkbox-item input[type="checkbox"] {
    margin-right: 5px;
    margin-top: 0;
  }
  
  .section-title {
    font-weight: bold;
    margin: 15px 0 10px 0;
    padding: 5px;
    background-color: #ddd;
    border-radius: 3px;
  }
  
  .special-note {
    font-size: 12px;
    color: #666;
    font-style: italic;
    margin-left: 20px;
  }
</style>
</head>
<body>
<h1>断線利用レールループ生成ツール</h1>
<small>断線を使用したレールループを生成してくれます。(beta版)<br>使い方は<a href="#HowtoUse">こちら</a></small>
<label>目標値[f]：
  <input type="number" id="target" value="300">
</label>
<label>最大表示数：
  <input type="number" id="limit" value="100">
</label>
<label>モード選択：
  <select id="mode">
    <option value="loop">周回モード</option>
    <option value="roundtrip">往復モード</option>
  </select>
</label>

<button type="button" class="collapsible">高度な設定</button>
使用するレールまたは断線の種類を選択します。<br>
<div class="content">
  <div class="section-title">基本レール</div>
  <div class="checkbox-group">
    <div class="checkbox-item">
      <input type="checkbox" id="check-s" checked>
      <label for="check-s">s - 直線レール (21f)</label>
    </div>
    <div class="checkbox-item">
      <input type="checkbox" id="check-d" checked>
      <label for="check-d">d - 斜線レール (30f)</label>
    </div>
    <div class="checkbox-item">
      <input type="checkbox" id="check-c" checked>
      <label for="check-c">c - 曲線レール (36f)</label>
    </div>
  </div>
  
  <div id="mode1-section">
    <div class="section-title">断線（周回モード）</div>
    <div id="mode1-checkboxes" class="checkbox-group">
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG1" checked>
        <label for="check-↓sG1">↓sG1 (31f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG2" checked>
        <label for="check-↓sG2">↓sG2 (38f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG3" checked>
        <label for="check-↓sG3">↓sG3 (45f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG4">
        <label for="check-↓sG4">↓sG4 (50f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG5">
        <label for="check-↓sG5">↓sG5 (56f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↓sG6">
        <label for="check-↓sG6">↓sG6 (60f)</label>
      </div>
      <br>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↑sG1" checked>
        <label for="check-↑sG1">↑sG1 (30f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↑sG2" checked>
        <label for="check-↑sG2">↑sG2 (39f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-↑sG3" checked>
        <label for="check-↑sG3">↑sG3 (54f)</label>
      </div>
    </div>
  </div>
  
  <div id="mode2-section" style="display:none;">
    <div class="section-title">断線（往復モード）</div>
    <div id="mode2-checkboxes" class="checkbox-group">
      <div class="checkbox-item">
        <input type="checkbox" id="check-sG1" checked>
        <label for="check-sG1">sG1 (61f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-sG2" checked>
        <label for="check-sG2">sG2 (77f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-sG3" checked>
        <label for="check-sG3">sG3 (99f)</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="check-sF">
        <label for="check-sF">sF (132f)</label>
      </div>
    </div>
  </div>
</div>

<div class="button-group">
  <button id="sortBtn" disabled>s-d差でソート</button>
  <button id="sortCBtn" disabled>c個数でソート</button>
  <button id="sortModeBtn" disabled>断線の個数でソート</button>
  <button id="filterBtn" disabled>断線が1種類以下で絞込</button>
  <button id="resetBtn" disabled>リセット</button>
  <br><button id="calc">生成</button>
</div>
<div id="results"></div>
<br>
<h1 id="HowtoUse">使い方</h1>
目標値に希望の値を入力し、モードを選択して「生成」ボタンを押すと結果が表示されます。<br>
目標値が大きくなるにつれ計算量も増えるため、最大表示数を適宜調整してください。<br>
<br>
<h2>レール(断線)種類</h2><br>
<h3>基本レール</h3>
s = 直線レール<br>
d = 斜線レール<br>
c = 曲線レール<br>
<h3>周回モード</h3>
↓sG1 = ↓G1-直線レール<br>
↓sG2 = ↓G2-直線レール<br>
↓sG3 = ↓G3-直線レール<br>
↓sG4 = ↓G4-直線レール<br>
↓sG5 = ↓G5-直線レール<br>
↓sG6 = ↓G6-直線レール<br>
↑sG1 = ↑G1-直線レール<br>
↑sG2 = ↑G2-直線レール<br>
↑sG3 = ↑G3-直線レール<br>
<h3>往復モード</h3>
sG1 = G1-直線レール<br>
sG2 = G2-直線レール<br>
sG3 = G3-直線レール<br>
sF = 直線レール-F<br>
<br>
<h2>ソート、絞り込みについて</h2>
ソート、絞り込みは「生成」ボタンを押した後に使用可能になります。<br>
<button>s-d差でソート</button> - sとdの個数の差の絶対値が小さい順にソートします。<br>
<button>c個数でソート</button> - cの個数が少ない順にソートします。<br>
<button>断線の個数でソート</button> - 断線の個数の合計が少ない順にソートします。<br>
<button>断線が1種類以下で絞込</button> - 断線が1種類以下の組み合わせに絞り込みます。<br>
<button>リセット</button> - ソート、絞り込み前の状態に戻します。<br>
<br>
<script>
const baseItems = [
  {name:"s", value:21, mode:0},
  {name:"d", value:30, mode:0},
  {name:"c", value:36, mode:0},
  {name:"↓sG1", value:31, mode:1},
  {name:"↓sG2", value:38, mode:1},
  {name:"↓sG3", value:45, mode:1},
  {name:"↓sG4", value:50, mode:1},
  {name:"↓sG5", value:56, mode:1},
  {name:"↓sG6", value:60, mode:1},
  {name:"↑sG1", value:30, mode:1},
  {name:"↑sG2", value:39, mode:1},
  {name:"↑sG3", value:54, mode:1},
  {name:"sG1", value:61, mode:2},
  {name:"sG2", value:77, mode:2},
  {name:"sG3", value:99, mode:2},
  {name:"sF", value:132, mode:3} // 特殊モード
];

let currentResults = [];
let displayedResults = []; // 現在表示されている結果

// 折りたたみ機能
document.addEventListener('DOMContentLoaded', function() {
  const coll = document.getElementsByClassName("collapsible");
  for (let i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      const content = this.nextElementSibling;
      content.classList.toggle("show");
    });
  }
});

// モード変更時のチェックボックス表示切り替え
document.getElementById('mode').addEventListener('change', function() {
  const mode = this.value;
  const mode1Section = document.getElementById('mode1-section');
  const mode2Section = document.getElementById('mode2-section');
  
  if (mode === 'loop') {
    mode1Section.style.display = 'block';
    mode2Section.style.display = 'none';
  } else {
    mode1Section.style.display = 'none';
    mode2Section.style.display = 'block';
  }
});

// 選択された基本レールを取得する関数
function getSelectedBaseItems() {
  const selected = [];
  baseItems.filter(item => item.mode === 0).forEach(item => {
    const checkbox = document.getElementById(`check-${item.name}`);
    if (checkbox && checkbox.checked) {
      selected.push(item);
    }
  });
  return selected;
}

// 選択された断線レールを取得する関数
function getSelectedMode1Items() {
  const selected = [];
  baseItems.filter(item => item.mode === 1).forEach(item => {
    const checkbox = document.getElementById(`check-${item.name}`);
    if (checkbox && checkbox.checked) {
      selected.push(item);
    }
  });
  return selected;
}

function getSelectedMode2Items() {
  const selected = [];
  baseItems.filter(item => item.mode === 2).forEach(item => {
    const checkbox = document.getElementById(`check-${item.name}`);
    if (checkbox && checkbox.checked) {
      selected.push(item);
    }
  });
  return selected;
}

// sFが選択されているかチェック
function isSFSelected() {
  const checkbox = document.getElementById('check-sF');
  return checkbox && checkbox.checked;
}

document.getElementById('calc').addEventListener('click', ()=>{
  const target = Number(document.getElementById('target').value);
  const limit  = Number(document.getElementById('limit').value);
  const mode   = document.getElementById('mode').value;
  
  // 選択された基本アイテム（mode:0）を取得
  let items = getSelectedBaseItems().map(it=>{
    if (mode === "roundtrip") {
      return {...it, value: it.value * 2};
    }
    return {...it};
  });
  
  // 選択された断線レールを追加
  if (mode === "loop") {
    items = items.concat(getSelectedMode1Items());
  } else if (mode === "roundtrip") {
    items = items.concat(getSelectedMode2Items());
    // sFが選択されている場合は追加（往復モードのみ）
    if (isSFSelected()) {
      items.push({name:"sF", value:132, mode:3});
    }
  }
  
  currentResults = findCombinations(target,limit,items);
  displayedResults = [...currentResults]; // 表示用結果も初期化
  document.getElementById('sortBtn').disabled = currentResults.length === 0;
  document.getElementById('sortModeBtn').disabled = currentResults.length === 0;
  document.getElementById('sortCBtn').disabled = currentResults.length === 0;
  document.getElementById('filterBtn').disabled = currentResults.length === 0;
  document.getElementById('resetBtn').disabled = currentResults.length === 0;
  render(displayedResults);
});

document.getElementById('sortModeBtn').addEventListener('click', ()=>{
  if(displayedResults.length === 0) return;
  
  // 現在表示されている結果をmode:1,2,3の個数の合計でソート（昇順）
  displayedResults = [...displayedResults].sort((a, b) => {
    const mode123ItemsA = baseItems.filter(item => item.mode === 1 || item.mode === 2 || item.mode === 3);
    const totalCountA = mode123ItemsA.reduce((sum, item) => sum + (a[item.name] || 0), 0);
    
    const mode123ItemsB = baseItems.filter(item => item.mode === 1 || item.mode === 2 || item.mode === 3);
    const totalCountB = mode123ItemsB.reduce((sum, item) => sum + (b[item.name] || 0), 0);
    
    return totalCountA - totalCountB;
  });
  
  render(displayedResults);
});

document.getElementById('sortCBtn').addEventListener('click', ()=>{
  if(displayedResults.length === 0) return;
  
  // 現在表示されている結果をcの個数でソート（昇順）
  displayedResults = [...displayedResults].sort((a, b) => {
    const cCountA = a["c"] || 0;
    const cCountB = b["c"] || 0;
    return cCountA - cCountB;
  });
  
  render(displayedResults);
});

document.getElementById('filterBtn').addEventListener('click', ()=>{
  if(displayedResults.length === 0) return;
  
  // 現在表示されている結果からmode:1,2,3の値が1種類以下の組み合わせを絞り込み
  displayedResults = displayedResults.filter(result => {
    // mode:1,2,3のアイテムで、個数が1以上のものを数える
    const mode123Items = baseItems.filter(item => item.mode === 1 || item.mode === 2 || item.mode === 3);
    const usedCount = mode123Items.filter(item => (result[item.name] || 0) > 0).length;
    return usedCount <= 1;
  });
  
  render(displayedResults);
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(currentResults.length === 0) return;
  
  // 元の計算結果に戻す
  displayedResults = [...currentResults];
  render(displayedResults);
});

document.getElementById('sortBtn').addEventListener('click', ()=>{
  if(displayedResults.length === 0) return;
  
  // 現在表示されている結果をs-d差の絶対値でソート（昇順）
  displayedResults = [...displayedResults].sort((a, b) => {
    const sCountA = a["s"] || 0;
    const dCountA = a["d"] || 0;
    const diffA = Math.abs(sCountA - dCountA);
    
    const sCountB = b["s"] || 0;
    const dCountB = b["d"] || 0;
    const diffB = Math.abs(sCountB - dCountB);
    
    return diffA - diffB;
  });
  
  render(displayedResults);
});

function render(results){
  const out = document.getElementById('results');
  if(results.length===0){
    out.textContent = '該当する組み合わせはありません。';
    return;
  }
  out.textContent = results.map(r=>formatCompact(r)).join("\n");
}

function formatCompact(r){
  return Object.entries(r)
    .filter(([k,v])=>v>0)
    .map(([k,v])=>`${k}×${v}`)
    .join(', ');
}

function findCombinations(target,limit,items){
  const results=[];
  const counts={};
  const sItem=items.find(i=>i.name==="s");
  
  function dfs(idx,remaining){
    if(results.length>=limit) return;
    if(idx===items.length){
      if(remaining===0){
        // 制約確認
        const sCount=counts["s"]||0;
        const m1sum=items.filter(i=>i.mode===1).reduce((sum,i)=>sum+(counts[i.name]||0),0);
        const m2sum=items.filter(i=>i.mode===2).reduce((sum,i)=>sum+(counts[i.name]||0),0);
        const m3sum=items.filter(i=>i.mode===3).reduce((sum,i)=>sum+(counts[i.name]||0),0);
        
        // sFの特殊制約：1回まで、sの個数制約を受けない
        if(m3sum > 1) return; // sFは1回まで
        
        // 通常の制約：mode1 ≤4, mode2 ≤2, (mode1+mode2) ≤ sCount
        // sFがある場合は、mode2が2回使われていてもOK（sFはsの制約を受けない）
        const normalMode2Sum = m2sum; // sFを除いたmode2の合計
        const constraintSum = m1sum + normalMode2Sum; // sFを除いた制約対象
        
        if(m1sum<=4 && m2sum<=2 && constraintSum<=sCount){
          results.push({...counts});
        }
      }
      return;
    }
    
    const item=items[idx];
    let max=Math.floor(remaining/item.value);
    
    // sFの場合は最大1回まで
    if(item.mode === 3) {
      max = Math.min(max, 1);
    }
    
    for(let n=max;n>=0;n--){
      counts[item.name]=n;
      dfs(idx+1,remaining-n*item.value);
    }
    counts[item.name]=0;
  }
  dfs(0,target);
  return results;
}
</script>
</body>
</html>